{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/advisory.css' %}">
<link rel="stylesheet" href="{% static 'css/chatbot.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<section class="report-section">
    <h1>ðŸŒ± Soil Report</h1>

    <div id="map" class="map-container"></div>

    <div id="report" class="report-box">
        {% if soil_data %}
            <pre id="soilText">{{ soil_data }}</pre>
            <button id="downloadBtn" class="download-button">ðŸ“¥ Download Report</button>
        {% else %}
            <p class="no-data">Soil data not available.</p>
        {% endif %}
    </div>
 
    <!-- Hidden CSRF token -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
</section>

<!-- ðŸŒ¾ KrishiBot Chat Section -->
<div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <div class="chat-header-info">
            <div class="bot-avatar">
                <img src="{% static 'img/small_logo.png' %}" alt="AI Assistant" />
                <span class="status-dot"></span>
            </div>
            <div class="bot-info">
                <h2>KrishiPath</h2>
                <p>AI Agricultural Assistant</p>
            </div>
        </div>
    </div>

    <!-- Chat Messages -->
    <div class="chat-messages" id="chat-messages">
        <div class="message bot-message">
            <div class="message-content">
                <p>ðŸ‘‹ Hello! I'm KrishiBot, your agricultural assistant. How can I help you today?</p>
            </div>
        </div>

        <div class="suggested-questions">
            <button class="suggestion-btn" onclick="askQuestion('What crops are suitable for my soil?')">
                What crops are suitable for my soil?
            </button>
            <button class="suggestion-btn" onclick="askQuestion('How to prevent common plant diseases?')">
                How to prevent common plant diseases?
            </button>
            <button class="suggestion-btn" onclick="askQuestion('Best fertilizers for organic farming?')">
                Best fertilizers for organic farming?
            </button>
        </div>
    </div>

    <!-- Chat Input -->
    <div class="chat-input-area">
        <div class="input-wrapper">
            <input 
                type="text" 
                id="user-input" 
                placeholder="Type your message here..."
                autocomplete="off"
            />
            <div class="input-actions">
                <button class="send-btn" id="send-btn" title="Send message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Main Script -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const hasSoilData = document.getElementById("soilText") !== null;

        // Run geolocation only if soil data is NOT available
        if (!hasSoilData) {
            initGeoLocation({
                enableMap: true,
                fetchUrls: ["{% url 'soil_report' %}", "{% url 'weather_current' %}"],
                csrfToken: "{{ csrf_token }}",
                onComplete: function(url) {
                    console.log("Location fetched successfully");
                }
            });
        }

        const downloadBtn = document.getElementById("downloadBtn");
        const soilText = document.getElementById("soilText");

        if (downloadBtn && soilText) {
            downloadBtn.addEventListener("click", function () {
                const blob = new Blob([soilText.textContent], { type: "text/plain" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "soil_report.txt";
                link.click();
                URL.revokeObjectURL(link.href);
            });
        }
    });

    // Chatbot Script
    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-btn');

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message bot-message';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            const messageText = document.createElement('p');
            messageText.textContent = message;

            const messageTime = document.createElement('span');
            messageTime.className = 'message-time';
            messageTime.textContent = 'Just now';

            messageContent.appendChild(messageText);
            messageContent.appendChild(messageTime);
            messageDiv.appendChild(messageContent);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (message) {
                addMessage(message, true);
                userInput.value = '';

                try {
                    const response = await fetch("{% url 'bot' %}", {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ question: message })
                    });

                    const data = await response.json();
                    if (data.answer) {
                        addMessage(data.answer, false);
                    } else {
                        addMessage("Sorry, I couldn't find an answer.", false);
                    }
                } catch (error) {
                    addMessage("Error connecting to server.", false);
                }
            }
        }

        sendButton.addEventListener('click', sendMessage);

        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        window.askQuestion = function(question) {
            userInput.value = question;
            sendMessage();
        };
    });
</script>

{% if lat and lon %}
<script>
    const lat = {{ lat }};
    const lon = {{ lon }};

    const mapContainer = document.getElementById("map");
    if (mapContainer) {
        const map = L.map(mapContainer).setView([lat, lon], 15);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        L.marker([lat, lon]).addTo(map).bindPopup("You are here").openPopup();
    }
</script>
{% endif %}

{% endblock %}
